name: Build

on:
  push:
    branches: [ master ]

jobs:

  build:
    name: Code generate
    runs-on: ubuntu-latest
    steps:

    - name: Set up Node
      uses: actions/setup-node@v2
      with:
        node-version: '15'
        check-latest: true

    - name: Check out the code
      uses: actions/checkout@v2

    - name: Get dependencies
      run: yarn

    - name: Generate production code
      run: yarn build --outDir /tmp/platform

    - name: Getting target SHA
      run: git rev-parse --short HEAD > /tmp/platform.v

    - name: Upload to repository
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
      run: |
        KEYFILE=$(mktemp)
        REPODIR=$(mktemp -d)
        GIT_SHA=$(cat /tmp/platform.v)
        git config --global user.email "buildbot@bassteam.freeland"
        git config --global user.name "BASSTeam build bot"
        chmod 600 "$KEYFILE"
        echo "$DEPLOY_KEY" > "$KEYFILE"
        cp -rp "$(pwd)/.ssh" ~
        echo "Host github.com" >> ~/.ssh/config
        echo " IdentityFile $KEYFILE" >> ~/.ssh/config
        git clone --depth=1 ssh://git@github.com/elements-web/elements-web.github.io "$REPODIR"
        mv "$REPODIR/.git" /tmp/platform/
        cd /tmp/platform
        touch /tmp/platform/.nojekyll
        git add .
        git commit --allow-empty -m "Build elements-web/core@$GIT_SHA"
        git push

    - name: Send notify to Telegam
      env:
        TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        TG_LOG_CHAT: ${{ secrets.TG_LOG_CHAT }}
      run: |
        GIT_SHA=$(cat /tmp/platform.v)
        TEXT=$(cat - <<EOF | node -
        function replaceSpecial(str, entity){
          return str.replaceAll(entity, '\\\\' + entity);
        }

        let str = \`
        Successfully built [elements-web/core@$GIT_SHA](https://github.com/elements-web/core/commit/$GIT_SHA).
        Access at https://elements-web.github.io
        \`;

        for(const entity of [
          '\\\\',
          '.',
          '-',
        ]) str = replaceSpecial(str, entity);

        console.log(encodeURIComponent(str));
        EOF
        )

        curl -s "https://api.telegram.org/bot$TG_BOT_TOKEN/sendMessage?chat_id=$TG_LOG_CHAT&parse_mode=MarkdownV2&text=$TEXT"
